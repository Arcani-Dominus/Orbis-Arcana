<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbis Arcana - Level 2</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="container">
        <img src="logo.png" alt="Orbis Arcana Logo" class="logo">
        <h1 class="title">ORBIS ARCANA</h1>
        <h2 class="subtitle">Level 2</h2>

        <p><strong>Riddle:</strong> The more you take, the more you leave behind. What am I?</p>

        <input type="text" id="answerInput" placeholder="Enter your answer">
        <button class="glow" onclick="checkAnswer()">Submit</button>

        <p id="result"></p>

        <a id="nextLevelLink" href="level3.html" style="display: none;">Proceed to Next Level</a>

        <!-- Leaderboard Section -->
        <div class="section-container">
            <h3 class="section-title" onclick="toggleSection('leaderboard')">Leaderboard</h3>
            <div id="leaderboard" class="section-content"></div>
        </div>

        <!-- Announcements Section -->
        <div class="section-container">
            <h3 class="section-title" onclick="toggleSection('announcements')">Announcements</h3>
            <div id="announcements" class="section-content"></div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        const correctAnswer = "footsteps"; 

        async function checkAnswer() {
            const userAnswer = document.getElementById("answerInput").value.trim().toLowerCase();
            const result = document.getElementById("result");
            const nextLevelLink = document.getElementById("nextLevelLink");
            const studentID = localStorage.getItem("studentID");

            if (userAnswer === correctAnswer) {
                result.innerHTML = "<span class='correct'>Correct! ðŸŽ‰</span>";
                nextLevelLink.style.display = "block";

                if (studentID) {
                    await setDoc(doc(db, "players", studentID), { level: 3 }, { merge: true });
                    localStorage.setItem("currentLevel", 3);
                }
            } else {
                result.innerHTML = "<span class='incorrect'>Incorrect! Try again.</span>";
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.style.display = section.style.display === "none" || section.style.display === "" ? "block" : "none";
        }

        async function loadLeaderboard() {
            const leaderboardDiv = document.getElementById("leaderboard");
            const querySnapshot = await getDocs(collection(db, "players"));
            let leaderboardHTML = "<ul>";
            querySnapshot.forEach(doc => {
                const player = doc.data();
                leaderboardHTML += `<li>${player.name} - Level ${player.level}</li>`;
            });
            leaderboardHTML += "</ul>";
            leaderboardDiv.innerHTML = leaderboardHTML;
        }

        async function loadAnnouncements() {
            const announcementsDiv = document.getElementById("announcements");
            const querySnapshot = await getDocs(collection(db, "announcements"));
            let announcementsHTML = "<ul>";
            querySnapshot.forEach(doc => {
                const announcement = doc.data();
                announcementsHTML += `<li>${announcement.message} - <em>${announcement.timestamp.toDate().toLocaleString()}</em></li>`;
            });
            announcementsHTML += "</ul>";
            announcementsDiv.innerHTML = announcementsHTML;
        }

        async function restoreProgress() {
            const studentID = localStorage.getItem("studentID");
            const currentLevel = localStorage.getItem("currentLevel");
            if (studentID && currentLevel >= 2) {
                const playerRef = doc(db, "players", studentID);
                const playerSnap = await getDoc(playerRef);
                if (playerSnap.exists()) {
                    if (playerSnap.data().level > 2) {
                        window.location.href = `level${playerSnap.data().level}.html`;
                    }
                }
            }
        }

        loadLeaderboard();
        loadAnnouncements();
        restoreProgress();
    </script>
</body>
</html>
