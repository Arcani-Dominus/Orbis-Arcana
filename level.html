<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbis Arcana - Level</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="container">
        <img src="Orbis Arcane.png" alt="Orbis Arcana Logo" class="logo">
        <h1 class="title">Orbis Arcana</h1>
        <h2 id="levelTitle">Level</h2>

        <!-- üìú Riddle Section -->
        <p id="riddleText" class="riddle">Loading riddle...</p>
        <input type="text" id="answerInput" class="input-field" placeholder="Enter your answer">
        <button id="submitAnswer" class="submit-button">Submit</button>
        <p id="feedback"></p>

        <!-- üí° Hint Section -->
        <button id="getHintBtn">Get Hint</button>
        <p id="hintDisplay"></p>

        <!-- üì¢ Announcements Section -->
        <p id="announcements">Loading announcements...</p>

        <!-- üèÜ Leaderboard Section -->
        <div id="leaderboard-section">
            <button id="loadLeaderboardBtn" class="toggle-button">üèÜ Show Leaderboard</button>
            <div id="leaderboard" class="hidden">Loading leaderboard...</div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from "./firebase-config.js";
        import { getDoc, doc, collection, query, orderBy, getDocs, updateDoc, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
        import { getRiddle, getAnswer, getAnnouncement } from "./levels.js";
        import { getHint } from "./hints.js"; // ‚úÖ Using your hints.js

        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const level = parseInt(urlParams.get("level")) || 1;

            const riddleText = document.getElementById("riddleText");
            const levelTitle = document.getElementById("levelTitle");
            const feedback = document.getElementById("feedback");
            const answerInput = document.getElementById("answerInput");

            levelTitle.innerText = `Level ${level}`;

            // ‚úÖ Load riddle
            const riddle = await getRiddle(level);
            riddleText.innerText = riddle || "Riddle not found!";

            // ‚úÖ Load announcements
            const announcements = await getAnnouncement();
            document.getElementById("announcements").innerText = announcements;

            // ‚úÖ Submit answer
            document.getElementById("submitAnswer").addEventListener("click", async () => {
                const user = auth.currentUser;
                if (!user) {
                    feedback.innerHTML = "<span style='color: red;'>Error: You need to log in first.</span>";
                    return;
                }
                const studentID = user.uid;
                const answer = answerInput.value.trim().toLowerCase();
                const correctAnswer = await getAnswer(level);

                if (answer && correctAnswer && answer === correctAnswer) {
                    feedback.innerHTML = "<span class='success-text'>Correct! Proceeding to next level...</span>";
                    const playerRef = doc(db, "players", studentID);
                    await updateDoc(playerRef, { 
                        level: level + 1,
                        timestamp: serverTimestamp()
                    });
                    setTimeout(() => {
                        window.location.href = `level.html?level=${level + 1}`;
                    }, 2000);
                } else {
                    feedback.innerHTML = "<span style='color: red;'>Wrong answer! Try again.</span>";
                }
            });

            // ‚úÖ Hint button
            document.getElementById("getHintBtn").addEventListener("click", async () => {
                await getHint(level); // hints.js handles DOM update
            });

            // ‚úÖ Leaderboard
            async function loadLeaderboard() {
                try {
                    const leaderboardDiv = document.getElementById("leaderboard");
                    leaderboardDiv.innerHTML = "<p>Loading...</p>";

                    const leaderboardQuery = query(
                        collection(db, "players"),
                        orderBy("level", "desc"),
                        orderBy("timestamp", "asc"),
                        limit(10)
                    );
                    const querySnapshot = await getDocs(leaderboardQuery);
                    if (querySnapshot.empty) {
                        leaderboardDiv.innerHTML = "<p>No players found.</p>";
                        return;
                    }

                    let leaderboardHTML = "<ol>";
                    querySnapshot.forEach(doc => {
                        const player = doc.data();
                        leaderboardHTML += `<li>${player.name || "Unknown"} - Level ${player.level}</li>`;
                    });
                    leaderboardHTML += "</ol>";
                    leaderboardDiv.innerHTML = leaderboardHTML;
                    leaderboardDiv.classList.remove("hidden");
                    leaderboardDiv.style.display = "block";
                } catch (error) {
                    console.error("Error loading leaderboard:", error);
                    document.getElementById("leaderboard").innerHTML = "<p>Error loading leaderboard.</p>";
                }
            }

            document.getElementById("loadLeaderboardBtn").addEventListener("click", () => {
                const leaderboardDiv = document.getElementById("leaderboard");
                if (leaderboardDiv.style.display === "none" || leaderboardDiv.classList.contains("hidden")) {
                    loadLeaderboard();
                } else {
                    leaderboardDiv.classList.add("hidden");
                    leaderboardDiv.style.display = "none";
                }
            });
        });
    </script>
</body>
</html>
